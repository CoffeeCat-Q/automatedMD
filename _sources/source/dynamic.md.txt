## Dynamic Quick User Guide

pyCADD.Dynamic 模块是为分子动力学模拟的自动化准备与运行而开发的功能模块，目的是为了让研究者专注在分子动力学模拟结果以及少数关键参数上，而无需关心和学习分子动力学模拟准备与执行的具体代码和流程或管道，以期能够提高学术问题的研究效率。

pyCADD提供了Python包调用和CLI(命令行工具)调用两种方式，其中CLI调用方式更加方便，但是Python包调用方式更加灵活。

### 文件准备
Dynamic模块只需要最少的必要输入和几个关键参数调节即可快速开始模拟过程。

要快速执行蛋白-小分子相互作用的分子动力学模拟，首先，您需要准备好一个开展模拟的蛋白结构文件 `protein_file` ，以及一个需要模拟的小分子文件 `molecule_file`, 2个文件都必须是PDB格式(`.pdb`)。
* 为了顺利执行模拟过程，2个结构的坐标应该是“合理”且“相近的”，即分子和蛋白的坐标应该在同一个空间区域中，且分子位于可能结合的位点上。因此，结构应该来自于分子对接软件的对接结果，或X-ray的衍射结构。
* 在研究一个新分子的动力学模拟前，应该先将其分子对接到相应的蛋白位点上，然后使用分子对接软件输出PDB格式结构。例如使用 Schrodinger Maestro 将纯蛋白部分与配体小分子拆分，然后**分别**输出为`.pdb`文件。
* 蛋白文件不应该包含任何配体小分子及任何水分子，小分子结构也不应该包含任何水分子。
* 如果使用 pyCADD.Dock 模块进行过分子对接，则可在 `protein` 及 `ligand` 目录下找到已经拆分好的蛋白和配体小分子的PDB格式结构文件。


### Python 包调用 Dynamic 模块

首先 从模块中导入结构预处理器 `Processor` 及实施分子动力学模拟的模拟器 `Simulator`, 然后创建一个预处理器实例 `processor`

```python
from pyCADD.Dynamic import Processor, Simulator
processor = Processor()     # 实例化的同时，将在当前目录创建所有必要的文件夹
```
#### 蛋白结构准备
使用processor的protein_prepare()方法 对蛋白结构文件进行自动预处理工作。
```python
processor.protein_prepare(protein_file)
```
这一过程包括以下几个步骤(需要AmberTools)：  
1. 去除蛋白结构中所有的水分子, 并补充标准氨基酸残基缺失的原子(add missing atoms), 得到后缀为`_dry.pdb`的文件。
2. 去除蛋白结构中的所有“原生”H原子，得到后缀为`_noH.pdb`的文件。
3. 使用AmberTools为蛋白结构重新生成蛋白力场下的H原子，得到后缀为`_leap.pdb`的文件。

所有此步骤的过程文件保存在`protein`目录中。

#### 小分子结构准备

使用processor的molecule_prepare()方法 对小分子结构文件进行自动预处理工作。
```python

# charge指定小分子结构的电荷量 根据实际情况改变 
# 当charge与实际不符时 Gaussian将报错 默认为0
# multiplicity指定小分子自旋多重度 默认为1

processor.molecule_prepare(molecule_file, charge=0, multiplicity=1)
```

这一过程包括以下几个步骤：
1. 高斯结构优化 (需要Gaussian 16, 使用泛函B3LYP、基组def2SVP、色散矫正em=GD3BJ、loose收敛限)
2. 计算小分子的RESP2电荷 (需要Multiwfn)并生成输出PDB结构`_out.pdb` 关于RESP2(0.5)电荷的更多信息，参阅[RESP2(0.5)电荷](http://sobereva.com/531)
3. antechamber (需要AmberTools) 生成Amber模拟模型参数文件`.prepin`
4. parmchk2 (需要AmberTools) 生成Amber模拟模型参数文件`.frcmod`
所有此步骤的过程文件保存在`molecule`目录中。

#### Amber 模拟前准备 - LEaP
在蛋白与小分子都准备就绪后，使用LEaP来完成最终的模拟准备文件生成。
为了方便识别生成文件，选择一个任意名称作为生成文件前缀名 `prefix` ，这通常可以是PDBID或配体小分子名等。
```python
prefix = '1FBY'
processor.leap_prepare(prefix)
```
这一过程包括以下几个步骤：
1. 创建tleap命令的输入文件 `_tleap.in`
2. 调用tleap命令为蛋白结构(pro)、小分子结构()lig以及二者复合物(com)生成必要的拓扑及坐标文件`.prmtop`、`.inpcrd`
3. 将复合物溶于TIP3P水箱中(size 12.0) 得到水箱复合物结构文件(`_comsolvate.pdb`)，并同时生成拓扑与坐标文件`_comsolvate.prmtop`、`_comsolvate.inpcrd`

所有此步骤的过程文件保存在`leap`目录中。

现在，如果没有产生预料之外的错误，预处理阶段已经完成。

#### 创建输入文件执行模拟
为了开始模拟阶段，首先 创建模拟器实例`simulator`，它需要此前的预处理器实例`processor`来完成构造工作。
```python
# 如果您需要不执行准备阶段直接进行模拟，可以构建一个新的Processor实例
# 并使用set_comsolvate_file(file_path:str, file_type:str)来设定已存在的水箱复合物结构3个必要文件路径
# 包括_comsolvate.pdb _comsolvate.prmtop _comsolvate.inpcrd
# new_processor = Processor()
# new_processor.set_comsolvate_file('leap/*_comsolvate.pdb', 'pdb')
# new_processor.set_comsolvate_file('leap/*_comsolvate.prmtop', 'top')
# new_processor.set_comsolvate_file('leap/*_comsolvate.inpcrd', 'crd')

simulator = Simulator(processor)
# simulator = Simulator(new_processor)
```
创建Amber模拟所需的一切输入文件将由creat_input_file()方法完成, 您只需要指定模拟步数及模拟步长2个参数。
模拟步数及步长决定了模拟的总时间长度 默认将为100ns。
```python
# step_num代表模拟步数 默认为50000000步
# step_length代表模拟步长 默认为0.002ps
# 模拟总时长 = step_num * step_length
# 默认总时长 = 50000000 * 0.002 ps = 100000 ps = 100ns
simulator.create_input_file(step_num=50000000, step_length=0.002)
```
最后 设定模拟使用的GPU设备编号，即可开始模拟。
```python
# 使用shwo_cuda_device()查看当前GPU信息
# simulator.show_cuda_device()
simulator.set_cuda_device(0)
simulator.run_simulation()
# or 
# simulator.run_simulation(cuda_device=0)
```

进程将阻塞至模拟完成。

### CLI 调用 Dynamic 模块

使用命令
```bash
pycadd-dynamic [option] protein_file molecule_file
```
即可快速完成以上全部过程。  

A simple demo:
```bash
mkdir 1FBY
cd 1FBY
cp SOMEWHERE/1FBY-pro-9CR.pdb ./
cp SOMEWHERE/1FBY-lig-9CR.pdb ./
pycadd-dynamic --charge -1 --multiplicity 1 --prefix 1FBY --parallel 48 --with-gpu 0 1FBY-pro-9CR.pdb 1FBY-lig-9CR.pdb
```
使用
```bash
pycadd-dynamic --help
```
获取参数设定的更多信息。